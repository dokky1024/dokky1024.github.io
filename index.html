<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA: The Rule Breaker</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { 
    --bg: #0d0d0f; --panel: #1a1a1f; --acc: #ff4757; 
    --text: #f1f2f6; --mafia: #8e44ad; --citizen: #2ecc71; 
}
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { 
    background: var(--bg); color: var(--text); 
    font-family: sans-serif; margin: 0; padding: 0;
    height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
}

/* ëª¨ë°”ì¼ì—ì„œ ë†’ì´ê°€ ê½‰ ì°¨ë„ë¡ ì„¤ì • */
html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }

#main-panel { height: 100%; display: flex; flex-direction: column; }
#log-view { flex: 1; overflow-y: auto; padding: 15px; }

/* í•˜ë‹¨ ì…ë ¥ë°”ê°€ í‚¤ë³´ë“œ ìœ„ë¡œ ì˜¤ë„ë¡ ì„¤ì • */
#bottom-ui { flex-shrink: 0; background: var(--panel); border-top: 1px solid #333; }
#input-bar { height: 60px; display: flex; padding: 10px; gap: 8px; }

/* ë‹‰ë„¤ì„ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
input { padding: 10px; border-radius: 5px; border: 1px solid #444; background: #000; color: #fff; }

/* ìƒë‹¨ ì •ë³´ì°½ */
#header { height: 50px; background: #000; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; border-bottom: 1px solid #333; flex-shrink: 0; }

/* ì°¸ì—¬ì ëª©ë¡ (ê°€ë¡œ ìŠ¤í¬ë¡¤ë¡œ ë³€ê²½í•˜ì—¬ ì±„íŒ… ê³µê°„ í™•ë³´) */
#player-list { 
    height: 110px; display: flex; overflow-x: auto; padding: 10px; gap: 10px; 
    background: #111; border-bottom: 1px solid #333; flex-shrink: 0;
}
.player-card { 
    min-width: 85px; height: 85px; background: #222; border-radius: 8px; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    font-size: 11px; border: 1px solid #444; flex-shrink: 0;
}
.player-card.selected { border: 2px solid var(--acc); background: #331a1a; }

/* ì±„íŒ… ë¡œê·¸ ì˜ì—­ */
#log-view { flex: 1; overflow-y: auto; padding: 15px; font-size: 14px; background: rgba(0,0,0,0.2); min-height: 0; }

/* í•˜ë‹¨ ì…ë ¥ ë° ì§ì—… ì •ë³´ */
#bottom-ui { background: var(--panel); border-top: 1px solid #333; flex-shrink: 0; }
#my-status { padding: 8px 15px; font-size: 13px; border-bottom: 1px solid #222; display: flex; gap: 10px; }
#input-bar { height: 60px; display: flex; padding: 10px; gap: 8px; }
input { flex: 1; background: #000; border: 1px solid #444; color: #fff; border-radius: 20px; padding: 0 15px; outline: none; font-size: 16px; /* ì•„ì´í° ìë™í™•ëŒ€ ë°©ì§€ */ }
#send-btn { background: none; border: none; color: var(--acc); font-weight: bold; padding: 0 10px; }
    </style>
</head>
<body>
<body>
    <body>
    <div id="nickname-overlay" style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:1000; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:#ff4757; margin-bottom:20px;">MAFIA: Rule Breaker</h2>
        <input type="text" id="nick-input" placeholder="ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”" style="width:250px; padding:12px; border-radius:25px; border:none; margin-bottom:15px; text-align:center;">
        <button onclick="setNickname()" style="width:250px; padding:12px; background:#ff4757; color:white; border:none; border-radius:25px; font-weight:bold; cursor:pointer;">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="header" style="height:50px; background:#000; display:flex; justify-content:space-between; align-items:center; padding:0 15px; border-bottom:1px solid #333;">
        <div onclick="toggleSidebar()" style="cursor:pointer; font-size:24px; color:#fff;">â˜°</div>
        <span id="phase-display" style="font-weight:bold; color:#ff4757;">ğŸ  LOBBY</span>
        <span id="room-info" style="font-size:12px; color:#888;">ROOM: 001 <span id="player-count" style="margin-left:5px;">(0)</span></span>
    </div>

    <div style="display:flex; flex:1; position:relative; overflow:hidden; height:calc(100vh - 50px);">
        <div id="sidebar" style="width:200px; background:#1a1a1f; border-right:1px solid #333; position:absolute; left:-200px; top:0; bottom:0; z-index:500; transition:0.3s; overflow-y:auto;">
            <div style="padding:15px; font-weight:bold; border-bottom:1px solid #333; color:#fff;">ì°¸ì—¬ì ëª©ë¡</div>
            <div id="player-list"></div>
        </div>

        <div id="main-panel" style="flex:1; display:flex; flex-direction:column; background:#0d0d0f;">
            <div id="log-view" style="flex:1; overflow-y:auto; padding:15px; font-size:14px; color:#ddd;"></div>
            
            <div id="bottom-ui" style="background:#1a1a1f; border-top:1px solid #333;">
                <div id="my-status" style="padding:8px 15px; font-size:13px; border-bottom:1px solid #222; display:flex; gap:10px;">
                    <b id="role-name" style="color:#ff4757;">ì—°ê²° ëŒ€ê¸°</b> : <span id="role-desc" style="color:#aaa;">ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</span>
                </div>
                <div id="input-bar" style="height:60px; display:flex; padding:10px; gap:8px;">
                    <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." style="flex:1; background:#000; border:1px solid #444; color:#fff; border-radius:20px; padding:0 15px; outline:none;">
                    <button id="send-btn" style="background:none; border:none; color:#ff4757; font-weight:bold; padding:0 10px; cursor:pointer;">ì „ì†¡</button>
                </div>
            </div>
        </div>
    </div>

<script>
// [ë³´ì•ˆ] ì ‘ì† ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì›í•˜ëŠ” ë¹„ë²ˆìœ¼ë¡œ ë°”ê¾¸ì„¸ìš”)
const ROOM_PASSWORD = "1234"; 
let accessGranted = false;

while (!accessGranted) {
    let inputPw = prompt("ë°© ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
    if (inputPw === ROOM_PASSWORD) {
        accessGranted = true;
        alert("ì ‘ì† ì„±ê³µ! ì¦ê±°ìš´ ê²Œì„ ë˜ì„¸ìš”.");
    } else {
        alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
    }
}

// --- [1] ê¸°ë³¸ ë³€ìˆ˜ ì„¤ì • ---
const roomID = "ROOM_001";
let myID = "";
let myRole = "ëŒ€ê¸°ì";
let gameState = { phase: "LOBBY", players: {}, targetList: {} };

// --- [2] Firebase ì„¤ì • ---
const firebaseConfig = {
    apiKey: "AIzaSyA6Plgr7YiOvluYlyWH3L3bhpQPDfvX0d0",
    authDomain: "mafiagamejjjdaon-8d20d.firebaseapp.com",
    databaseURL: "https://mafiagamejjjdaon-8d20d-default-rtdb.firebaseio.com",
    projectId: "mafiagamejjjdaon-8d20d",
    storageBucket: "mafiagamejjjdaon-8d20d.firebasestorage.app",
    messagingSenderId: "740156732852",
    appId: "1:740156732852:web:738ccad1d04e9f83a52ee1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// [ë‹‰ë„¤ì„ ì„¤ì • í•¨ìˆ˜]
function setNickname() {
    const nick = document.getElementById('nick-input').value.trim();
    if (!nick) { alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }
    
    myID = nick; // ì…ë ¥í•œ ë‹‰ë„¤ì„ì„ IDë¡œ ì‚¬ìš©
    document.getElementById('nickname-overlay').style.display = 'none';
    
    // DBì— ìœ ì € ì •ë³´ ë“±ë¡
    db.ref(`rooms/${roomID}/players/${myID}`).set({
        uid: myID, isAlive: true, role: "ëŒ€ê¸°ì", team: "none"
    });
    addLog(`[ì‹œìŠ¤í…œ] ${myID}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
}

// [ì‚¬ì´ë“œë°” í† ê¸€ í•¨ìˆ˜]
let sidebarOpen = false;
function toggleSidebar() {
    const sb = document.getElementById('sidebar');
    sidebarOpen = !sidebarOpen;
    sb.style.left = sidebarOpen ? "0" : "-200px";
}

// [ì±„íŒ… ì „ì†¡ ë¡œì§ ì¬í™•ì¸] - ê¼­ ë‹¤ì‹œ ì²´í¬í•˜ì„¸ìš”!
const sBtn = document.getElementById('send-btn');
const cInput = document.getElementById('chat-input');

sBtn.onclick = () => {
    if(!cInput.value || !myID) return;
    db.ref(`rooms/${roomID}/chats`).push({
        sender: myID,
        text: cInput.value
    });
    cInput.value = "";
};
cInput.onkeypress = (e) => { if(e.key === 'Enter') sBtn.onclick(); };

// --- [3] 20ì¢… ì „ì²´ ì§ì—… ë°ì´í„° ì •ì˜ ---
const ROLES = {
    "ì‹œë¯¼": { team: "citizen", priority: 10, desc: "ì¶”ë¦¬ë¡œ ë§ˆí”¼ì•„ë¥¼ ì¡ìœ¼ì„¸ìš”." },
    "ì˜ì‚¬": { team: "citizen", priority: 2, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì„ ë§ˆí”¼ì•„ì˜ ê³µê²©ìœ¼ë¡œë¶€í„° ì¹˜ë£Œí•©ë‹ˆë‹¤." },
    "ê²½ì°°": { team: "citizen", priority: 5, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì´ ë§ˆí”¼ì•„ì¸ì§€ ì¡°ì‚¬í•©ë‹ˆë‹¤." },
    "êµ°ì¸": { team: "citizen", priority: 3, desc: "ê³µê²©ì„ 1íšŒ ê²¬ë””ë©° ìŠ¤íŒŒì´ì˜ ì¡°ì‚¬ë¥¼ ì•Œì•„ì±•ë‹ˆë‹¤." },
    "ì •ì¹˜ì¸": { team: "citizen", priority: 9, desc: "íˆ¬í‘œ ì‹œ 2í‘œë¡œ ê³„ì‚°ë˜ë©° ì²˜í˜•ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." },
    "ì˜ë§¤": { team: "citizen", priority: 6, desc: "ì£½ì€ ìë“¤ì˜ ëŒ€í™”ë¥¼ ë“£ìŠµë‹ˆë‹¤." },
    "ì—°ì¸": { team: "citizen", priority: 8, desc: "ì„œë¡œë¥¼ ì•Œ ìˆ˜ ìˆìœ¼ë©° í•œ ëª… ì‚¬ë§ ì‹œ ê°™ì´ ì£½ìŠµë‹ˆë‹¤." },
    "ìê²½ë‹¨": { team: "citizen", priority: 4, desc: "ë°¤ì— í•œ ëª…ì„ ì‚¬ì‚´í•©ë‹ˆë‹¤. ì‹œë¯¼ ì‚¬ì‚´ ì‹œ ìì‚´í•©ë‹ˆë‹¤." },
    "ê¸°ì": { team: "citizen", priority: 7, desc: "ì¡°ì‚¬í•œ ì‚¬ëŒì˜ ì§ì—…ì„ ë‹¤ìŒë‚  ê³µí‘œí•©ë‹ˆë‹¤." },
    "í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸": { team: "citizen", priority: 9, desc: "ì²˜í˜• ì‹œ í•œ ëª…ì„ ê°™ì´ ë°ë ¤ê°‘ë‹ˆë‹¤." },
    "ì‚¬ì„¤íƒì •": { team: "citizen", priority: 5, desc: "ëˆ„êµ¬ë¥¼ í´ë¦­í–ˆëŠ”ì§€ ë™ì„ ì„ í™•ì¸í•©ë‹ˆë‹¤." },
    "ì„±ì§ì": { team: "citizen", priority: 1, desc: "ì‚¬ë§ì í•œ ëª…ì„ ë¶€í™œì‹œí‚µë‹ˆë‹¤. (1íšŒ)" },
    "ê¸°ìˆ ì": { team: "citizen", priority: 1, desc: "ì„ íƒí•œ ì‚¬ëŒì˜ ëŠ¥ë ¥ì„ ê·¸ë‚  ë°¤ ë¬´ë ¥í™”í•©ë‹ˆë‹¤." },
    "ë§ˆí”¼ì•„": { team: "mafia", priority: 4, desc: "ë°¤ë§ˆë‹¤ ì‹œë¯¼ í•œ ëª…ì„ ì‚´í•´í•©ë‹ˆë‹¤." },
    "ìŠ¤íŒŒì´": { team: "mafia", priority: 5, desc: "í•œ ëª…ì˜ ì •ì²´ë¥¼ ì•Œì•„ë‚´ ë§ˆí”¼ì•„ì™€ ì ‘ì„ í•©ë‹ˆë‹¤." },
    "ì§ìŠ¹ì¸ê°„": { team: "mafia", priority: 4, desc: "ë§ˆí”¼ì•„ ì¡°ì‚¬ì— ê±¸ë¦¬ì§€ ì•Šìœ¼ë©° í•¨ê»˜ ê³µê²©í•©ë‹ˆë‹¤." },
    "ë§ˆë…€": { team: "mafia", priority: 4, desc: "ì €ì£¼ë¡œ ì˜ì‚¬ì˜ ì¹˜ë£Œë¥¼ ë¬´ì‹œí•˜ê³  ì£½ì…ë‹ˆë‹¤." },
    "ì•”ì‚´ì": { team: "mafia", priority: 4, desc: "ì§ì—…ì„ ë§ì¶”ë©´ ì¦‰ì‹œ ì‚´í•´í•©ë‹ˆë‹¤." },
    "ë„ë‘‘": { team: "neutral", priority: 2, desc: "ì§ì—…ì„ í›”ì¹©ë‹ˆë‹¤." },
    "êµì£¼": { team: "neutral", priority: 8, desc: "ì‚¬ëŒë“¤ì„ í¬êµí•˜ì—¬ ìŠ¹ë¦¬ë¥¼ ë…¸ë¦½ë‹ˆë‹¤." }
};

// --- [4] ì´ˆê¸° ì ‘ì† ë° ì±„íŒ… ì„¤ì • ---
db.ref(`rooms/${roomID}/players/${myID}`).set({
    uid: myID, isAlive: true, role: "ëŒ€ê¸°ì", team: "none"
});
db.ref(`rooms/${roomID}/players/${myID}`).onDisconnect().remove();

const chatInput = document.getElementById('chat-input');
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && chatInput.value.trim()) {
        const text = chatInput.value;
        db.ref(`rooms/${roomID}/chats`).push({ sender: myID, text: text });
        chatInput.value = "";
    }
});

db.ref(`rooms/${roomID}/chats`).on('child_added', (snapshot) => {
    const chat = snapshot.val();
    addLog(`${chat.sender}: ${chat.text}`);
    if (chat.text === "!ê²Œì„ì‹œì‘") checkAndStartGame();
});

function addLog(msg, color = "#fff") {
    const logView = document.getElementById('log-view');
    const div = document.createElement('div');
    div.innerText = msg;
    div.style.color = color;
    logView.appendChild(div);
    logView.scrollTop = logView.scrollHeight;
}

// --- [5] ê²Œì„ ì‹œìŠ¤í…œ ë¡œì§ (ì‹œì‘, ì§ì—… ë°°ì •) ---
function checkAndStartGame() {
    db.ref(`rooms/${roomID}/players`).once('value', (snapshot) => {
        const players = snapshot.val() || {};
        const uids = Object.keys(players);
        if (uids.length < 3) { alert("ìµœì†Œ 3ëª… ì´ìƒì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤!"); return; }

        let rolePool = ["ë§ˆí”¼ì•„", "ì˜ì‚¬", "ê²½ì°°", "ê¸°ìˆ ì", "êµ°ì¸", "ìŠ¤íŒŒì´"];
        while (rolePool.length < uids.length) rolePool.push("ì‹œë¯¼");
        rolePool = rolePool.sort(() => Math.random() - 0.5);

        uids.forEach((uid, index) => {
            const rName = rolePool[index];
            players[uid].role = rName;
            players[uid].team = ROLES[rName].team;
            players[uid].isAlive = true;
            players[uid].life = (rName === "êµ°ì¸") ? 1 : 0;
        });

        db.ref(`rooms/${roomID}`).update({
            phase: "NIGHT", day: 1, players: players, targetList: {}, winner: null
        });
        addLog("[ì‹œìŠ¤í…œ] ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ë°¤ì´ ì°¾ì•„ì™”ìŠµë‹ˆë‹¤.", "var(--acc)");
    });
}

// --- [6] ë°¤ì˜ ëŠ¥ë ¥ ì‚¬ìš© (í´ë¦­ ì´ë²¤íŠ¸) ---
function selectTarget(targetId) {
    if (gameState.phase !== "NIGHT") return;
    if (myRole === "ì‹œë¯¼" || myRole === "ì •ì¹˜ì¸") {
        addLog("ë‹¹ì‹ ì€ ëŠ¥ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.", "#888");
        return;
    }
    db.ref(`rooms/${roomID}/targetList/${myID}`).set({ from: myID, to: targetId, role: myRole });
    addLog(`${targetId}ë‹˜ì„ íƒ€ê²Ÿìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`, "var(--acc)");
    
    // ê°•ì¡° í‘œì‹œ
    const cards = document.querySelectorAll('.player-card');
    cards.forEach(c => {
        c.classList.remove('selected');
        if (c.getAttribute('data-uid') === targetId) c.classList.add('selected');
    });
}

// --- [7] ì‹¤ì‹œê°„ ë°ì´í„° ê°ì‹œ ë° UI ì—…ë°ì´íŠ¸ ---
db.ref(`rooms/${roomID}`).on('value', (snapshot) => {
    gameState = snapshot.val() || {};
    const players = gameState.players || {};
    const listContainer = document.getElementById('player-list');
    listContainer.innerHTML = "";
    
    document.getElementById('player-count').innerText = Object.keys(players).length;

    Object.keys(players).forEach(uid => {
        const p = players[uid];
        const div = document.createElement('div');
        div.className = `player-card ${p.isAlive ? '' : 'dead'}`;
        div.setAttribute('data-uid', uid);
        div.innerHTML = `<span>${uid}${uid === myID ? ' (ë‚˜)' : ''}</span><span class="badge ${p.isAlive ? 'status-alive' : 'status-dead'}">${p.isAlive ? 'ìƒì¡´' : 'ì‚¬ë§'}</span>`;
        
        if (p.isAlive && gameState.phase === "NIGHT") div.onclick = () => selectTarget(uid);
        listContainer.appendChild(div);
    });

    if (players[myID]) {
        myRole = players[myID].role;
        document.getElementById('role-name').innerText = `ë‚´ ì§ì—…: ${myRole}`;
        document.getElementById('role-name').style.color = (players[myID].team === "mafia") ? "var(--mafia)" : "var(--citizen)";
        document.getElementById('role-desc').innerText = ROLES[myRole]?.desc || "ëŒ€ê¸° ì¤‘...";
    }

    const phaseEl = document.getElementById('phase-display');
    phaseEl.innerText = `ğŸ•’ ${gameState.phase} - ${gameState.day || 0}ì¼`;
    document.body.style.backgroundColor = (gameState.phase === "NIGHT") ? "#050505" : "#0d0d0f";
});

// --- [8] ë°¤ ê²°ê³¼ ì²˜ë¦¬ ë° ìŠ¹ë¦¬ íŒì • (ë°©ì¥ ì „ìš©) ---
setInterval(() => {
    // ê°€ì¥ ë¨¼ì € ì…ì¥í•œ ì‚¬ëŒì´ ë°©ì¥ ì—­í• ì„ ìˆ˜í–‰í•˜ì—¬ ê²°ê³¼ ì²˜ë¦¬
    if (gameState.phase === "NIGHT" && Object.keys(gameState.players)[0] === myID) {
        const targets = gameState.targetList || {};
        const activePlayers = Object.values(gameState.players).filter(p => p.isAlive && p.role !== "ì‹œë¯¼" && p.role !== "ì •ì¹˜ì¸");
        
        if (Object.keys(targets).length >= activePlayers.length && activePlayers.length > 0) {
            processNightResults();
        }
    }
}, 4000);

function processNightResults() {
    const players = gameState.players;
    const targets = gameState.targetList || {};
    let deadTonight = new Set();
    let logs = [];

    // 1. ê¸°ìˆ ì ëŠ¥ë ¥ ì°¨ë‹¨
    Object.values(targets).forEach(t => {
        if (t.role === "ê¸°ìˆ ì" && targets[t.to]) {
            delete targets[t.to];
            logs.push("âš™ï¸ ê¸°ìˆ ìê°€ ëŠ¥ë ¥ì„ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤!");
        }
    });

    // 2. ì˜ì‚¬ ì¹˜ë£Œ í™•ì¸
    const healed = new Set();
    Object.values(targets).forEach(t => { if (t.role === "ì˜ì‚¬") healed.add(t.to); });

    // 3. ê³µê²© íŒì •
    Object.values(targets).forEach(t => {
        if (["ë§ˆí”¼ì•„", "ë§ˆë…€", "ì•”ì‚´ì", "ìê²½ë‹¨"].includes(t.role)) {
            if (healed.has(t.to) && t.role !== "ë§ˆë…€") {
                logs.push("ğŸ¥ ì˜ì‚¬ê°€ ëˆ„êµ°ê°€ë¥¼ ì‚´ë ¤ëƒˆìŠµë‹ˆë‹¤!");
            } else if (players[t.to].role === "êµ°ì¸" && players[t.to].life > 0) {
                players[t.to].life--;
                logs.push("ğŸ›¡ï¸ êµ°ì¸ì´ ê³µê²©ì„ ë²„í…¼ìŠµë‹ˆë‹¤!");
            } else {
                deadTonight.add(t.to);
            }
        }
    });

    deadTonight.forEach(uid => { players[uid].isAlive = false; logs.push(`ğŸ’€ ${uid}ë‹˜ì´ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤.`); });
    if (logs.length === 0) logs.push("â˜€ï¸ ì§€ë‚œë°¤ì—ëŠ” ì•„ë¬´ ì¼ë„ ì—†ì—ˆìŠµë‹ˆë‹¤.");

    const winner = checkVictory(players);
    db.ref(`rooms/${roomID}`).update({
        players: players, phase: "DAY", targetList: {}, day: gameState.day + 1, winner: winner || null
    });
    
    logs.forEach(l => db.ref(`rooms/${roomID}/chats`).push({ sender: "ì‹œìŠ¤í…œ", text: l }));
}

function checkVictory(players) {
    const alive = Object.values(players).filter(p => p.isAlive);
    const mCount = alive.filter(p => p.team === "mafia").length;
    const cCount = alive.filter(p => p.team === "citizen").length;
    if (mCount === 0) return "CITIZEN";
    if (mCount >= cCount) return "MAFIA";
    return null;
}

db.ref(`rooms/${roomID}/winner`).on('value', (snap) => {
    if (snap.val()) alert(`${snap.val()} ìŠ¹ë¦¬!`);
});
</script>
</body>
</html>






