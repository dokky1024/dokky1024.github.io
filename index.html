<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA: The Rule Breaker</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        /* ê²Œì„ ë°°ê²½ ë° ìƒ‰ìƒ ì„¤ì • */
        :root { 
            --bg: #0d0d0f; --panel: #1a1a1f; --acc: #ff4757; 
            --text: #f1f2f6; --mafia: #8e44ad; --citizen: #2ecc71; 
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            margin: 0; display: flex; height: 100vh; overflow: hidden; 
        }
        
        /* ì™¼ìª½: í”Œë ˆì´ì–´ ëª©ë¡ ì°½ */
        #side-panel { width: 300px; background: var(--panel); border-right: 2px solid #333; display: flex; flex-direction: column; }
        
        /* ì˜¤ë¥¸ìª½: ì±„íŒ… ë° ë¡œê·¸ ì°½ */
        #main-panel { flex: 1; display: flex; flex-direction: column; }
        
        .player-card { 
            padding: 15px; border-bottom: 1px solid #333; cursor: pointer; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .player-card.dead { opacity: 0.3; background: #000; pointer-events: none; }
        .player-card.selected { border: 2px solid var(--acc); background: #2c2c34; }
        
        #log-view { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.3); font-size: 14px; line-height: 1.6; }
        
        #input-bar { height: 60px; background: #000; display: flex; padding: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; outline: none; }
        
        #my-status { padding: 20px; background: #111; border-top: 2px solid var(--acc); }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-alive { background: var(--citizen); color: #000; }
        .status-dead { background: var(--acc); color: #fff; }
    </style>
</head>
<body>

<div id="side-panel">
    <div style="padding: 20px; font-weight: bold; border-bottom: 2px solid #333; background: #000;">ì°¸ì—¬ì ëª©ë¡</div>
    <div id="player-list" style="flex: 1; overflow-y: auto;">
        </div>
    <div id="my-status">
        <div id="role-name" style="font-size: 1.2em; color: var(--acc); font-weight: bold;">ëŒ€ê¸°ì‹¤</div>
        <div id="role-desc" style="font-size: 0.9em; color: #aaa; margin-top: 5px;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</div>
    </div>
</div>

<div id="main-panel">
    <div id="header" style="padding: 15px; background: #000; display: flex; justify-content: space-between; border-bottom: 1px solid #333;">
        <span id="phase-display">ğŸ  LOBBY</span>
        <span id="room-info">ROOM: 001</span>
    </div>
    <div id="log-view">
        <div style="color: #666;">[ì‹œìŠ¤í…œ] ê²Œì„ì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. !ê²Œì„ì‹œì‘ ëª…ë ¹ì–´ë¡œ ì‹œì‘í•˜ì„¸ìš”.</div>
    </div>
    <div id="input-bar">
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ëŒ€ìƒì„ ì„ íƒí•˜ì„¸ìš”...">
    </div>
</div>

<script>

// ì ‘ì†í•˜ìë§ˆì ì‹¤í–‰ë˜ëŠ” ì…ì¥ ì½”ë“œ
db.ref(`rooms/${roomID}/players/${myID}`).set({
    uid: myID,
    isAlive: true,
    role: "ëŒ€ê¸°ì",
    team: "none"
});

// ì°½ì„ ë‹«ìœ¼ë©´ DBì—ì„œ ì‚­ì œ (ì„ íƒ ì‚¬í•­)
db.ref(`rooms/${roomID}/players/${myID}`).onDisconnect().remove();

// --- [1] Firebase ì„¤ì • (ë³¸ì¸ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”) ---
const firebaseConfig = {
    apiKey: "AIzaSyA6Plgr7YiOvluYlyWH3L3bhpQPDfvX0d0",
    authDomain: "mafiagamejjjdaon-8d20d.firebaseapp.com",
    databaseURL: "https://mafiagamejjjdaon-8d20d-default-rtdb.firebaseio.com",
    projectId: "mafiagamejjjdaon-8d20d",
    storageBucket: "mafiagamejjjdaon-8d20d.firebasestorage.app",
    messagingSenderId: "740156732852",
    appId: "1:740156732852:web:738ccad1d04e9f83a52ee1"
};

// Firebase ì´ˆê¸°í™”
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Firebase ì—°ê²° ë„êµ¬ ìƒì„±
const db = firebase.database();

// [ì¤‘ìš”] ì ‘ì†í•˜ìë§ˆì ë‚´ ì •ë³´ë¥¼ DBì— ë“±ë¡í•˜ëŠ” ì½”ë“œ
// ì´ ì½”ë“œê°€ ì‹¤í–‰ë˜ì–´ì•¼ 403 ì—ëŸ¬ê°€ ì‚¬ë¼ì§€ê³  ë°ì´í„°ê°€ ìŒ“ì…ë‹ˆë‹¤.
db.ref(`rooms/${roomID}/players/${myID}`).set({
    uid: myID,
    isAlive: true,
    role: "ëŒ€ê¸°ì",
    team: "none"
}).then(() => {
    console.log("DB ì ‘ì† ì„±ê³µ!");
}).catch((error) => {
    console.error("DB ì ‘ì† ì‹¤íŒ¨(403 ë“±): ", error);

// --- [2] ê²Œì„ ê¸°ë³¸ ë³€ìˆ˜ ---
let roomID = "ROOM_001"; // ë‚˜ì¤‘ì— ë°© ìƒì„± ê¸°ëŠ¥ìœ¼ë¡œ í™•ì¥ ê°€ëŠ¥
let myID = "Player_" + Math.floor(Math.random() * 1000);
let myRole = "";
let gameState = {};

// --- [3] 20ì¢… ì§ì—… ë°ì´í„° ì •ì˜ (íŒ€, ì„¤ëª…, ìš°ì„ ìˆœìœ„) ---
const ROLES = {
    // ì‹œë¯¼íŒ€ (Citizen Team)
    "ì‹œë¯¼": { team: "citizen", priority: 10, desc: "íŠ¹ìˆ˜í•œ ëŠ¥ë ¥ì€ ì—†ì§€ë§Œ íˆ¬í‘œë¡œ ë§ˆí”¼ì•„ë¥¼ ì¡ìœ¼ì„¸ìš”." },
    "ì˜ì‚¬": { team: "citizen", priority: 2, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì„ ì„ íƒí•´ ë§ˆí”¼ì•„ì˜ ê³µê²©ìœ¼ë¡œë¶€í„° ì¹˜ë£Œí•©ë‹ˆë‹¤." },
    "ê²½ì°°": { team: "citizen", priority: 5, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì„ ì¡°ì‚¬í•´ ë§ˆí”¼ì•„ì¸ì§€ í™•ì¸í•©ë‹ˆë‹¤." },
    "êµ°ì¸": { team: "citizen", priority: 3, desc: "ë§ˆí”¼ì•„ì˜ ê³µê²©ì„ 1íšŒ ê²¬ëŒë‚´ë©°, ìŠ¤íŒŒì´ì˜ ì¡°ì‚¬ë¥¼ ì•Œì•„ì±•ë‹ˆë‹¤." },
    "ì •ì¹˜ì¸": { team: "citizen", priority: 9, desc: "íˆ¬í‘œ ì‹œ 2í‘œë¡œ ê³„ì‚°ë˜ë©°, íˆ¬í‘œë¡œ ì²˜í˜•ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤." },
    "ì˜ë§¤": { team: "citizen", priority: 6, desc: "ì£½ì€ ì‚¬ëŒë“¤ì˜ ì±„íŒ…ì„ ë³¼ ìˆ˜ ìˆê³ , ì„±ë¶ˆì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤." },
    "ì—°ì¸": { team: "citizen", priority: 8, desc: "ë‘ ëª…ì´ ë°°ì •ë©ë‹ˆë‹¤. ë°¤ì— ì„œë¡œ ì±„íŒ…ì´ ê°€ëŠ¥í•˜ë©° í•œ ìª½ì´ ì£½ìœ¼ë©´ ê°™ì´ ì£½ìŠµë‹ˆë‹¤." },
    "ìê²½ë‹¨": { team: "citizen", priority: 4, desc: "ë°¤ì— í•œ ëª…ì„ ì‚¬ì‚´í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì‹œë¯¼ ì‚¬ì‚´ ì‹œ ë³¸ì¸ë„ ì‚¬ë§í•©ë‹ˆë‹¤." },
    "ê¸°ì": { team: "citizen", priority: 7, desc: "ë°¤ì— í•œ ëª…ì„ ì·¨ì¬í•´ ë‹¤ìŒ ë‚  ì•„ì¹¨ ëª¨ë“  í”Œë ˆì´ì–´ì—ê²Œ ì •ì²´ë¥¼ ê³µê°œí•©ë‹ˆë‹¤." },
    "í…ŒëŸ¬ë¦¬ìŠ¤íŠ¸": { team: "citizen", priority: 9, desc: "íˆ¬í‘œë¡œ ì²˜í˜•ë  ë•Œ í•œ ëª…ì„ ì§€ëª©í•´ ê°™ì´ í­ì‚¬ì‹œí‚µë‹ˆë‹¤." },
    "ì‚¬ì„¤íƒì •": { team: "citizen", priority: 5, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì„ ì¡°ì‚¬í•´ ëˆ„êµ¬ë¥¼ ì„ íƒí–ˆëŠ”ì§€ ì•Œì•„ëƒ…ë‹ˆë‹¤." },
    "ì„±ì§ì": { team: "citizen", priority: 1, desc: "ì£½ì€ í”Œë ˆì´ì–´ í•œ ëª…ì„ ë¶€í™œì‹œí‚¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (1íšŒ)" },
    "ê¸°ìˆ ì": { team: "citizen", priority: 1, desc: "ë°¤ì— í•œ ëª…ì„ ì„ íƒí•´ ê·¸ ì‚¬ëŒì˜ ëŠ¥ë ¥ì„ ê·¸ë‚  ë°¤ì—ë§Œ ë¬´ë ¥í™”í•©ë‹ˆë‹¤." },

    // ë§ˆí”¼ì•„íŒ€ (Mafia Team)
    "ë§ˆí”¼ì•„": { team: "mafia", priority: 4, desc: "ë°¤ë§ˆë‹¤ ì‹œë¯¼ í•œ ëª…ì„ ì§€ëª©í•˜ì—¬ ì‚´í•´í•©ë‹ˆë‹¤." },
    "ìŠ¤íŒŒì´": { team: "mafia", priority: 5, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì˜ ì§ì—…ì„ ì•Œì•„ë‚´ë©°, ë§ˆí”¼ì•„ì™€ ì ‘ì„ í•©ë‹ˆë‹¤." },
    "ì§ìŠ¹ì¸ê°„": { team: "mafia", priority: 4, desc: "ë§ˆí”¼ì•„ê°€ ìœ ëŒ€ìƒì„ ê°™ì´ ê³µê²©í•˜ë©°, ë§ˆí”¼ì•„ ì¡°ì‚¬ì— ê±¸ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤." },
    "ë§ˆë…€": { team: "mafia", priority: 4, desc: "ë°¤ë§ˆë‹¤ ì €ì£¼ë¥¼ ê±¸ì–´ ëŒ€ìƒì„ ì£½ì…ë‹ˆë‹¤. ì˜ì‚¬ì˜ ì¹˜ë£Œë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤." },
    "ì•”ì‚´ì": { team: "mafia", priority: 4, desc: "ì§ì—…ì„ ì •í™•íˆ ë§ì¶”ë©´ ëŒ€ìƒì„ ì¦‰ì‹œ ì‚´í•´í•©ë‹ˆë‹¤." },

    // ì¤‘ë¦½íŒ€ (Neutral Team)
    "ë„ë‘‘": { team: "neutral", priority: 2, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì˜ ì§ì—…ì„ í›”ì³ ë³¸ì¸ì˜ ê²ƒìœ¼ë¡œ ë§Œë“­ë‹ˆë‹¤." },
    "êµì£¼": { team: "neutral", priority: 8, desc: "ë°¤ë§ˆë‹¤ í•œ ëª…ì„ í¬êµí•©ë‹ˆë‹¤. ëª¨ë“  ìƒì¡´ìê°€ í¬êµë˜ë©´ ìŠ¹ë¦¬í•©ë‹ˆë‹¤." }
};

// --- [4] ì±„íŒ… ìˆ˜ì‹  ë° ëª…ë ¹ì–´ ì²˜ë¦¬ ---
db.ref(`rooms/${roomID}/chats`).on('child_added', (snapshot) => {
    const chat = snapshot.val();
    addLog(`${chat.sender}: ${chat.text}`);

    // "!ê²Œì„ì‹œì‘" ëª…ë ¹ì–´ë¥¼ ê°ì§€í•˜ë©´ ê²Œì„ ì‹¤í–‰
    if (chat.text === "!ê²Œì„ì‹œì‘") {
        checkAndStartGame();
    }
});

function addLog(msg) {
    const logView = document.getElementById('log-view');
    const div = document.createElement('div');
    div.innerText = msg;
    logView.appendChild(div);
    logView.scrollTop = logView.scrollHeight;
}

// --- [5] ì§ì—… ë°°ì • ë° ê²Œì„ ì´ˆê¸°í™” ë¡œì§ ---
function checkAndStartGame() {
    // í˜„ì¬ ì ‘ì†ëœ í”Œë ˆì´ì–´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    db.ref(`rooms/${roomID}/players`).once('value', (snapshot) => {
        const players = snapshot.val() || {};
        const uids = Object.keys(players);

        if (uids.length < 3) {
            alert("ìµœì†Œ 3ëª… ì´ìƒì˜ í”Œë ˆì´ì–´ê°€ í•„ìš”í•©ë‹ˆë‹¤!");
            return;
        }

        // ì§ì—… ë°°ì • ìˆœì„œ (ì¸ì›ìˆ˜ì— ë”°ë¼ ìœ ë™ì ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
        // ì—¬ê¸°ì— 2ë¶€ì—ì„œ ë§Œë“  20ì¢… ì§ì—… ì¤‘ í•µì‹¬ ì§ì—…ë“¤ì„ ë¨¼ì € ë°°ì¹˜í•©ë‹ˆë‹¤.
        let rolePool = ["ë§ˆí”¼ì•„", "ì˜ì‚¬", "ê²½ì°°", "êµ°ì¸", "ìŠ¤íŒŒì´", "ìê²½ë‹¨", "ê¸°ìˆ ì"];
        
        // ì¸ì›ìˆ˜ê°€ ë§ìœ¼ë©´ ë‚¨ì€ ìë¦¬ëŠ” 'ì‹œë¯¼'ìœ¼ë¡œ ì±„ì›€
        while (rolePool.length < uids.length) {
            rolePool.push("ì‹œë¯¼");
        }

        // ì§ì—… ì…”í”Œ (ëœë¤ ì„ê¸°)
        rolePool = rolePool.sort(() => Math.random() - 0.5);

        // í”Œë ˆì´ì–´ ë°ì´í„° ì—…ë°ì´íŠ¸
        uids.forEach((uid, index) => {
            players[uid].role = rolePool[index];
            players[uid].team = ROLES[rolePool[index]].team;
            players[uid].isAlive = true;
            players[uid].life = (rolePool[index] === "êµ°ì¸") ? 1 : 0; // êµ°ì¸ ì „ìš© ëª©ìˆ¨
        });

        // Firebaseì— ê²Œì„ ìƒíƒœ ì „ì†¡ (ì²« ë²ˆì§¸ ë°¤ ì‹œì‘)
        db.ref(`rooms/${roomID}`).update({
            phase: "NIGHT",
            day: 1,
            players: players,
            targetList: {} // ë°¤ ì‚¬ì´ ì„ íƒí•œ íƒ€ê²Ÿ ì´ˆê¸°í™”
        });

        alert("ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ë‹¹ì‹ ì˜ ì§ì—…ì„ í™•ì¸í•˜ì„¸ìš”.");
    });
}

// --- [6] ë‚´ ì •ë³´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ---
// (ë‚´ê°€ ì–´ë–¤ ì§ì—…ì¸ì§€ í™”ë©´ ì™¼ìª½ í•˜ë‹¨ì— í‘œì‹œí•´ì£¼ëŠ” ê¸°ëŠ¥)
db.ref(`rooms/${roomID}/players/${myID}`).on('value', (snapshot) => {
    const data = snapshot.val();
    if (data && data.role) {
        myRole = data.role;
        document.getElementById('role-name').innerText = `ë‚´ ì§ì—…: ${myRole}`;
        document.getElementById('role-desc').innerText = ROLES[myRole].desc;
        
        // ë§ˆí”¼ì•„íŒ€ì´ë©´ ì´ë¦„ ìƒ‰ìƒì„ ë³´ë¼ìƒ‰ìœ¼ë¡œ í‘œì‹œ
        if (data.team === "mafia") {
            document.getElementById('role-name').style.color = "var(--mafia)";
        } else {
            document.getElementById('role-name').style.color = "var(--citizen)";
        }
    }
});

// --- [7] ë°¤ì˜ í™œë™: ëŒ€ìƒ ì„ íƒ (í´ë¦­ ì´ë²¤íŠ¸) ---
function selectTarget(targetId) {
    // ë°¤ì´ê³ , ë‚´ê°€ ì‚´ì•„ìˆì„ ë•Œë§Œ ëŠ¥ë ¥ ì‚¬ìš© ê°€ëŠ¥
    if (gameState.phase !== "NIGHT") return;
    
    // ë‚´ ì§ì—…ì´ ëŠ¥ë ¥ì´ ì—†ëŠ” 'ì‹œë¯¼'ì´ë‚˜ 'ì •ì¹˜ì¸' ë“±ì´ë¼ë©´ í´ë¦­ ë°©ì§€
    const passiveRoles = ["ì‹œë¯¼", "ì •ì¹˜ì¸", "ì˜ë§¤"];
    if (passiveRoles.includes(myRole)) {
        addLog("ë‹¹ì‹ ì˜ ì§ì—…ì€ ë°¤ì— ì„ íƒí•  ìˆ˜ ìˆëŠ” ëŠ¥ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.", "#aaa");
        return;
    }

    // ì„ íƒí•œ íƒ€ê²Ÿ ì •ë³´ë¥¼ Firebaseì— ì„ì‹œ ì €ì¥
    // (ëˆ„ê°€(myID), ì–´ë–¤ ì§ì—…ìœ¼ë¡œ(myRole), ëˆ„êµ¬ë¥¼(targetId) ì„ íƒí–ˆëŠ”ì§€)
    db.ref(`rooms/${roomID}/targetList/${myID}`).set({
        from: myID,
        to: targetId,
        role: myRole
    });

    addLog(`${targetId}ë‹˜ì„ íƒ€ê²Ÿìœ¼ë¡œ ì„ íƒí–ˆìŠµë‹ˆë‹¤.`, "var(--acc)");
    highlightSelected(targetId);
}

// ì„ íƒëœ í”Œë ˆì´ì–´ ì¹´ë“œ ê°•ì¡° í‘œì‹œ
function highlightSelected(targetId) {
    const cards = document.querySelectorAll('.player-card');
    cards.forEach(card => {
        card.classList.remove('selected');
        if (card.getAttribute('data-uid') === targetId) {
            card.classList.add('selected');
        }
    });
}

// --- [8] ì‹¤ì‹œê°„ í™”ë©´ ê°±ì‹  (UI Update) ---
// ë°ì´í„°ê°€ ë³€í•  ë•Œë§ˆë‹¤ ëª©ë¡ì„ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
db.ref(`rooms/${roomID}`).on('value', (snapshot) => {
    gameState = snapshot.val() || {};
    const players = gameState.players || {};
    
    const listContainer = document.getElementById('player-list');
    listContainer.innerHTML = ""; // ê¸°ì¡´ ëª©ë¡ ì´ˆê¸°í™”

    Object.keys(players).forEach(uid => {
        const p = players[uid];
        const div = document.createElement('div');
        div.className = `player-card ${p.isAlive ? '' : 'dead'}`;
        div.setAttribute('data-uid', uid); // íƒ€ê²ŸíŒ…ì„ ìœ„í•œ ID ì €ì¥
        
        // ë‚´ ì•„ì´ë”” ì˜†ì—ëŠ” (ë‚˜) í‘œì‹œ
        const nameTag = (uid === myID) ? `${uid} (ë‚˜)` : uid;
        
        div.innerHTML = `
            <span>${nameTag}</span>
            <span class="badge ${p.isAlive ? 'status-alive' : 'status-dead'}">
                ${p.isAlive ? 'ìƒì¡´' : 'ì‚¬ë§'}
            </span>
        `;

        // ìƒì¡´í•´ ìˆê³ , ë°¤ì´ë¼ë©´ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ ì„¤ì •
        if (p.isAlive && gameState.phase === "NIGHT") {
            div.onclick = () => selectTarget(uid);
        }

        listContainer.appendChild(div);
    });

    // í˜„ì¬ ê²Œì„ ë‹¨ê³„(ë‚®/ë°¤) í‘œì‹œ ì—…ë°ì´íŠ¸
    const phaseEl = document.getElementById('phase-display');
    phaseEl.innerText = `ğŸ•’ ${gameState.phase || 'LOBBY'} - ${gameState.day || 0}ì¼ì§¸`;
    
    if (gameState.phase === "NIGHT") {
        phaseEl.style.color = "var(--mafia)";
        document.body.style.backgroundColor = "#050505"; // ë°¤ì—ëŠ” ë” ì–´ë‘¡ê²Œ
    } else {
        phaseEl.style.color = "var(--citizen)";
        document.body.style.backgroundColor = var(--bg);
    }
});

// --- [9] ë°¤ì˜ ê²°ê³¼ íŒì • (ì•„ì¹¨ì´ ì˜¬ ë•Œ í˜¸ì¶œ) ---
function processNightResults() {
    const players = gameState.players;
    const targets = gameState.targetList || {}; // ë°¤ìƒˆ ìŒ“ì¸ ì„ íƒ ëª©ë¡
    let deadTonight = new Set();
    let logs = [];

    // [Step 1] ê¸°ìˆ ì(Engineer) - ìµœìš°ì„  ìˆœìœ„ (ëŠ¥ë ¥ ì°¨ë‹¨)
    Object.keys(targets).forEach(fromId => {
        if (targets[fromId].role === "ê¸°ìˆ ì") {
            const victimId = targets[fromId].to;
            if (targets[victimId]) {
                delete targets[victimId]; // ì°¨ë‹¨ëœ ì‚¬ëŒì˜ í–‰ë™ì„ ì§€ì›€
                logs.push(`âš™ï¸ ê¸°ìˆ ìê°€ ëˆ„êµ°ê°€ì˜ ì¥ë¹„ë¥¼ ê³ ì¥ëƒˆìŠµë‹ˆë‹¤!`);
            }
        }
    });

    // [Step 2] ì˜ì‚¬(Doctor) - ì¹˜ë£Œ ëŒ€ìƒ í™•ì¸
    const healedPlayers = new Set();
    Object.values(targets).forEach(t => {
        if (t.role === "ì˜ì‚¬") healedPlayers.add(t.to);
    });

    // [Step 3] ê³µê²© ì²˜ë¦¬ (ë§ˆí”¼ì•„, ë§ˆë…€, ì•”ì‚´ì ë“±)
    Object.keys(targets).forEach(fromId => {
        const action = targets[fromId];
        const victimId = action.to;

        if (["ë§ˆí”¼ì•„", "ë§ˆë…€", "ì•”ì‚´ì", "ìê²½ë‹¨"].includes(action.role)) {
            // ì˜ì‚¬ê°€ ì‚´ë ¸ëŠ”ê°€? (ë§ˆë…€ì˜ ì €ì£¼ëŠ” ì˜ì‚¬ë„ ëª» ë§‰ìŒ)
            if (healedPlayers.has(victimId) && action.role !== "ë§ˆë…€") {
                logs.push(`ğŸ¥ ì˜ì‚¬ê°€ ${victimId}ë‹˜ì„ ê·¹ì ìœ¼ë¡œ ì‚´ë ¤ëƒˆìŠµë‹ˆë‹¤!`);
            } else {
                // êµ°ì¸ ë°©íƒ„ í™•ì¸
                if (players[victimId].role === "êµ°ì¸" && players[victimId].life > 0) {
                    players[victimId].life--;
                    logs.push(`ğŸ›¡ï¸ êµ°ì¸ì´ ìŠµê²©ì„ ë²„í…¨ëƒˆìŠµë‹ˆë‹¤!`);
                } else {
                    deadTonight.add(victimId);
                }
            }
        }
    });

    // [Step 4] ê²°ê³¼ ë°˜ì˜
    deadTonight.forEach(uid => {
        players[uid].isAlive = false;
        logs.push(`ğŸ’€ ${uid}ë‹˜ì´ ì²˜ì°¸í•˜ê²Œ ì‚¬ë§í•˜ì…¨ìŠµë‹ˆë‹¤.`);
    });

    if (deadTonight.size === 0 && logs.length === 0) {
        logs.push("â˜€ï¸ ì§€ë‚œë°¤ì—ëŠ” ì•„ë¬´ ì¼ë„ ì¼ì–´ë‚˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
    }

    // [Step 5] ìŠ¹ë¦¬ ì¡°ê±´ ì²´í¬
    const winner = checkVictory(players);

    // [Step 6] DB ì—…ë°ì´íŠ¸ (ë‚®ìœ¼ë¡œ ì „í™˜)
    db.ref(`rooms/${roomID}`).update({
        players: players,
        phase: "DAY",
        targetList: {}, // íƒ€ê²Ÿ ì´ˆê¸°í™”
        winner: winner || null
    });

    // ì•„ì¹¨ ì•Œë¦¼ ë¡œê·¸ ì „ì†¡
    logs.forEach(msg => addLog(msg, "#fffa65"));
}

// --- [10] ìŠ¹ë¦¬ ì¡°ê±´ íŒì • ---
function checkVictory(players) {
    const alive = Object.values(players).filter(p => p.isAlive);
    const mafiaCount = alive.filter(p => p.team === "mafia").length;
    const citizenCount = alive.filter(p => p.team === "citizen").length;

    if (mafiaCount === 0) return "CITIZEN_WIN";
    if (mafiaCount >= citizenCount) return "MAFIA_WIN";
    return null;
}

// 5ì´ˆë§ˆë‹¤ ë°¤ì´ ëë‚¬ëŠ”ì§€ ì²´í¬ (ë˜ëŠ” ìˆ˜ë™ ë²„íŠ¼ìœ¼ë¡œ ì¡°ì ˆ ê°€ëŠ¥)
// í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ë°¤ì— ëª¨ë“  ìƒì¡´ìê°€ ì„ íƒì„ ì™„ë£Œí•˜ë©´ ìë™ìœ¼ë¡œ ì•„ì¹¨ì´ ì˜¤ê²Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
setInterval(() => {
    if (gameState.phase === "NIGHT" && myID === Object.keys(gameState.players)[0]) {
        const targets = gameState.targetList || {};
        const aliveCount = Object.values(gameState.players).filter(p => p.isAlive && ROLES[p.role].priority < 8).length;
        
        if (Object.keys(targets).length >= aliveCount) {
            processNightResults();
        }
    }
}, 3000);

// ìŠ¹ë¦¬ ì‹œ ì•Œë¦¼
db.ref(`rooms/${roomID}/winner`).on('value', (snap) => {
    const winner = snap.val();
    if (winner) {
        alert(winner === "MAFIA_WIN" ? "ë§ˆí”¼ì•„ê°€ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ğŸ”¥" : "ì‹œë¯¼ì´ ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤! ğŸŒ±");
        // ê²Œì„ ì´ˆê¸°í™” ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
    }
});
</script>
</body>

</html>


