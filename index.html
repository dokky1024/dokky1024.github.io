<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MAFIA: The Rule Breaker</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <style>
        :root { 
            --bg: #0d0d0f; --panel: #1a1a1f; --acc: #ff4757; 
            --text: #f1f2f6; --mafia: #8e44ad; --citizen: #2ecc71; 
        }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: 'Apple SD Gothic Neo', sans-serif; 
            margin: 0; display: flex; height: 100vh; overflow: hidden; 
        }
        #side-panel { width: 300px; background: var(--panel); border-right: 2px solid #333; display: flex; flex-direction: column; }
        #main-panel { flex: 1; display: flex; flex-direction: column; }
        .player-card { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .player-card:hover { background: #25252b; }
        .player-card.dead { opacity: 0.3; background: #000; pointer-events: none; }
        .player-card.selected { border: 2px solid var(--acc); background: #2c2c34; }
        #log-view { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.3); font-size: 14px; line-height: 1.8; }
        #input-bar { height: 60px; background: #000; display: flex; padding: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; outline: none; }
        #my-status { padding: 20px; background: #111; border-top: 2px solid var(--acc); }
        .badge { padding: 3px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .status-alive { background: var(--citizen); color: #000; }
        .status-dead { background: var(--acc); color: #fff; }
    </style>
</head>
<body>

<div id="side-panel">
    <div style="padding: 20px; font-weight: bold; border-bottom: 2px solid #333; background: #000; display: flex; justify-content: space-between;">
        Ï∞∏Ïó¨Ïûê Î™©Î°ù <span id="player-count" style="color: var(--acc);">0</span>
    </div>
    <div id="player-list" style="flex: 1; overflow-y: auto;"></div>
    <div id="my-status">
        <div id="role-name" style="font-size: 1.2em; color: var(--acc); font-weight: bold;">Ïó∞Í≤∞ ÎåÄÍ∏∞ Ï§ë...</div>
        <div id="role-desc" style="font-size: 0.9em; color: #aaa; margin-top: 5px;">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî.</div>
    </div>
</div>

<div id="main-panel">
    <div id="header" style="padding: 15px; background: #000; display: flex; justify-content: space-between; border-bottom: 1px solid #333;">
        <span id="phase-display" style="font-weight: bold;">üè† LOBBY</span>
        <span id="room-info" style="color: #666;">ROOM: 001</span>
    </div>
    <div id="log-view"></div>
    <div id="input-bar">
        <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò !Í≤åÏûÑÏãúÏûëÏùÑ ÏπòÏÑ∏Ïöî...">
    </div>
</div>

<script>
// --- [1] Í∏∞Î≥∏ Î≥ÄÏàò ÏÑ§Ï†ï ---
const roomID = "ROOM_001";
const myID = "Player_" + Math.floor(Math.random() * 1000);
let myRole = "ÎåÄÍ∏∞Ïûê";
let gameState = { phase: "LOBBY", players: {}, targetList: {} };

// --- [2] Firebase ÏÑ§Ï†ï ---
const firebaseConfig = {
    apiKey: "AIzaSyA6Plgr7YiOvluYlyWH3L3bhpQPDfvX0d0",
    authDomain: "mafiagamejjjdaon-8d20d.firebaseapp.com",
    databaseURL: "https://mafiagamejjjdaon-8d20d-default-rtdb.firebaseio.com",
    projectId: "mafiagamejjjdaon-8d20d",
    storageBucket: "mafiagamejjjdaon-8d20d.firebasestorage.app",
    messagingSenderId: "740156732852",
    appId: "1:740156732852:web:738ccad1d04e9f83a52ee1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// --- [3] 20Ï¢Ö Ï†ÑÏ≤¥ ÏßÅÏóÖ Îç∞Ïù¥ÌÑ∞ Ï†ïÏùò ---
const ROLES = {
    "ÏãúÎØº": { team: "citizen", priority: 10, desc: "Ï∂îÎ¶¨Î°ú ÎßàÌîºÏïÑÎ•º Ïû°ÏúºÏÑ∏Ïöî." },
    "ÏùòÏÇ¨": { team: "citizen", priority: 2, desc: "Î∞§ÎßàÎã§ Ìïú Î™ÖÏùÑ ÎßàÌîºÏïÑÏùò Í≥µÍ≤©ÏúºÎ°úÎ∂ÄÌÑ∞ ÏπòÎ£åÌï©ÎãàÎã§." },
    "Í≤ΩÏ∞∞": { team: "citizen", priority: 5, desc: "Î∞§ÎßàÎã§ Ìïú Î™ÖÏù¥ ÎßàÌîºÏïÑÏù∏ÏßÄ Ï°∞ÏÇ¨Ìï©ÎãàÎã§." },
    "Íµ∞Ïù∏": { team: "citizen", priority: 3, desc: "Í≥µÍ≤©ÏùÑ 1Ìöå Í≤¨ÎîîÎ©∞ Ïä§ÌååÏù¥Ïùò Ï°∞ÏÇ¨Î•º ÏïåÏïÑÏ±ïÎãàÎã§." },
    "Ï†ïÏπòÏù∏": { team: "citizen", priority: 9, desc: "Ìà¨Ìëú Ïãú 2ÌëúÎ°ú Í≥ÑÏÇ∞ÎêòÎ©∞ Ï≤òÌòïÎêòÏßÄ ÏïäÏäµÎãàÎã§." },
    "ÏòÅÎß§": { team: "citizen", priority: 6, desc: "Ï£ΩÏùÄ ÏûêÎì§Ïùò ÎåÄÌôîÎ•º Îì£ÏäµÎãàÎã§." },
    "Ïó∞Ïù∏": { team: "citizen", priority: 8, desc: "ÏÑúÎ°úÎ•º Ïïå Ïàò ÏûàÏúºÎ©∞ Ìïú Î™Ö ÏÇ¨Îßù Ïãú Í∞ôÏù¥ Ï£ΩÏäµÎãàÎã§." },
    "ÏûêÍ≤ΩÎã®": { team: "citizen", priority: 4, desc: "Î∞§Ïóê Ìïú Î™ÖÏùÑ ÏÇ¨ÏÇ¥Ìï©ÎãàÎã§. ÏãúÎØº ÏÇ¨ÏÇ¥ Ïãú ÏûêÏÇ¥Ìï©ÎãàÎã§." },
    "Í∏∞Ïûê": { team: "citizen", priority: 7, desc: "Ï°∞ÏÇ¨Ìïú ÏÇ¨ÎûåÏùò ÏßÅÏóÖÏùÑ Îã§ÏùåÎÇ† Í≥µÌëúÌï©ÎãàÎã§." },
    "ÌÖåÎü¨Î¶¨Ïä§Ìä∏": { team: "citizen", priority: 9, desc: "Ï≤òÌòï Ïãú Ìïú Î™ÖÏùÑ Í∞ôÏù¥ Îç∞Î†§Í∞ëÎãàÎã§." },
    "ÏÇ¨ÏÑ§ÌÉêÏ†ï": { team: "citizen", priority: 5, desc: "ÎàÑÍµ¨Î•º ÌÅ¥Î¶≠ÌñàÎäîÏßÄ ÎèôÏÑ†ÏùÑ ÌôïÏù∏Ìï©ÎãàÎã§." },
    "ÏÑ±ÏßÅÏûê": { team: "citizen", priority: 1, desc: "ÏÇ¨ÎßùÏûê Ìïú Î™ÖÏùÑ Î∂ÄÌôúÏãúÌÇµÎãàÎã§. (1Ìöå)" },
    "Í∏∞Ïà†Ïûê": { team: "citizen", priority: 1, desc: "ÏÑ†ÌÉùÌïú ÏÇ¨ÎûåÏùò Îä•Î†•ÏùÑ Í∑∏ÎÇ† Î∞§ Î¨¥Î†•ÌôîÌï©ÎãàÎã§." },
    "ÎßàÌîºÏïÑ": { team: "mafia", priority: 4, desc: "Î∞§ÎßàÎã§ ÏãúÎØº Ìïú Î™ÖÏùÑ ÏÇ¥Ìï¥Ìï©ÎãàÎã§." },
    "Ïä§ÌååÏù¥": { team: "mafia", priority: 5, desc: "Ìïú Î™ÖÏùò Ï†ïÏ≤¥Î•º ÏïåÏïÑÎÇ¥ ÎßàÌîºÏïÑÏôÄ Ï†ëÏÑ†Ìï©ÎãàÎã§." },
    "ÏßêÏäπÏù∏Í∞Ñ": { team: "mafia", priority: 4, desc: "ÎßàÌîºÏïÑ Ï°∞ÏÇ¨Ïóê Í±∏Î¶¨ÏßÄ ÏïäÏúºÎ©∞ Ìï®Íªò Í≥µÍ≤©Ìï©ÎãàÎã§." },
    "ÎßàÎÖÄ": { team: "mafia", priority: 4, desc: "Ï†ÄÏ£ºÎ°ú ÏùòÏÇ¨Ïùò ÏπòÎ£åÎ•º Î¨¥ÏãúÌïòÍ≥† Ï£ΩÏûÖÎãàÎã§." },
    "ÏïîÏÇ¥Ïûê": { team: "mafia", priority: 4, desc: "ÏßÅÏóÖÏùÑ ÎßûÏ∂îÎ©¥ Ï¶âÏãú ÏÇ¥Ìï¥Ìï©ÎãàÎã§." },
    "ÎèÑÎëë": { team: "neutral", priority: 2, desc: "ÏßÅÏóÖÏùÑ ÌõîÏπ©ÎãàÎã§." },
    "ÍµêÏ£º": { team: "neutral", priority: 8, desc: "ÏÇ¨ÎûåÎì§ÏùÑ Ìè¨ÍµêÌïòÏó¨ ÏäπÎ¶¨Î•º ÎÖ∏Î¶ΩÎãàÎã§." }
};

// --- [4] Ï¥àÍ∏∞ Ï†ëÏÜç Î∞è Ï±ÑÌåÖ ÏÑ§Ï†ï ---
db.ref(`rooms/${roomID}/players/${myID}`).set({
    uid: myID, isAlive: true, role: "ÎåÄÍ∏∞Ïûê", team: "none"
});
db.ref(`rooms/${roomID}/players/${myID}`).onDisconnect().remove();

const chatInput = document.getElementById('chat-input');
chatInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && chatInput.value.trim()) {
        const text = chatInput.value;
        db.ref(`rooms/${roomID}/chats`).push({ sender: myID, text: text });
        chatInput.value = "";
    }
});

db.ref(`rooms/${roomID}/chats`).on('child_added', (snapshot) => {
    const chat = snapshot.val();
    addLog(`${chat.sender}: ${chat.text}`);
    if (chat.text === "!Í≤åÏûÑÏãúÏûë") checkAndStartGame();
});

function addLog(msg, color = "#fff") {
    const logView = document.getElementById('log-view');
    const div = document.createElement('div');
    div.innerText = msg;
    div.style.color = color;
    logView.appendChild(div);
    logView.scrollTop = logView.scrollHeight;
}

// --- [5] Í≤åÏûÑ ÏãúÏä§ÌÖú Î°úÏßÅ (ÏãúÏûë, ÏßÅÏóÖ Î∞∞Ï†ï) ---
function checkAndStartGame() {
    db.ref(`rooms/${roomID}/players`).once('value', (snapshot) => {
        const players = snapshot.val() || {};
        const uids = Object.keys(players);
        if (uids.length < 3) { alert("ÏµúÏÜå 3Î™Ö Ïù¥ÏÉÅÏùò ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÌïÑÏöîÌï©ÎãàÎã§!"); return; }

        let rolePool = ["ÎßàÌîºÏïÑ", "ÏùòÏÇ¨", "Í≤ΩÏ∞∞", "Í∏∞Ïà†Ïûê", "Íµ∞Ïù∏", "Ïä§ÌååÏù¥"];
        while (rolePool.length < uids.length) rolePool.push("ÏãúÎØº");
        rolePool = rolePool.sort(() => Math.random() - 0.5);

        uids.forEach((uid, index) => {
            const rName = rolePool[index];
            players[uid].role = rName;
            players[uid].team = ROLES[rName].team;
            players[uid].isAlive = true;
            players[uid].life = (rName === "Íµ∞Ïù∏") ? 1 : 0;
        });

        db.ref(`rooms/${roomID}`).update({
            phase: "NIGHT", day: 1, players: players, targetList: {}, winner: null
        });
        addLog("[ÏãúÏä§ÌÖú] Í≤åÏûÑÏù¥ ÏãúÏûëÎêòÏóàÏäµÎãàÎã§! Î∞§Ïù¥ Ï∞æÏïÑÏôîÏäµÎãàÎã§.", "var(--acc)");
    });
}

// --- [6] Î∞§Ïùò Îä•Î†• ÏÇ¨Ïö© (ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏) ---
function selectTarget(targetId) {
    if (gameState.phase !== "NIGHT") return;
    if (myRole === "ÏãúÎØº" || myRole === "Ï†ïÏπòÏù∏") {
        addLog("ÎãπÏã†ÏùÄ Îä•Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.", "#888");
        return;
    }
    db.ref(`rooms/${roomID}/targetList/${myID}`).set({ from: myID, to: targetId, role: myRole });
    addLog(`${targetId}ÎãòÏùÑ ÌÉÄÍ≤üÏúºÎ°ú ÏÑ†ÌÉùÌñàÏäµÎãàÎã§.`, "var(--acc)");
    
    // Í∞ïÏ°∞ ÌëúÏãú
    const cards = document.querySelectorAll('.player-card');
    cards.forEach(c => {
        c.classList.remove('selected');
        if (c.getAttribute('data-uid') === targetId) c.classList.add('selected');
    });
}

// --- [7] Ïã§ÏãúÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Í∞êÏãú Î∞è UI ÏóÖÎç∞Ïù¥Ìä∏ ---
db.ref(`rooms/${roomID}`).on('value', (snapshot) => {
    gameState = snapshot.val() || {};
    const players = gameState.players || {};
    const listContainer = document.getElementById('player-list');
    listContainer.innerHTML = "";
    
    document.getElementById('player-count').innerText = Object.keys(players).length;

    Object.keys(players).forEach(uid => {
        const p = players[uid];
        const div = document.createElement('div');
        div.className = `player-card ${p.isAlive ? '' : 'dead'}`;
        div.setAttribute('data-uid', uid);
        div.innerHTML = `<span>${uid}${uid === myID ? ' (ÎÇò)' : ''}</span><span class="badge ${p.isAlive ? 'status-alive' : 'status-dead'}">${p.isAlive ? 'ÏÉùÏ°¥' : 'ÏÇ¨Îßù'}</span>`;
        
        if (p.isAlive && gameState.phase === "NIGHT") div.onclick = () => selectTarget(uid);
        listContainer.appendChild(div);
    });

    if (players[myID]) {
        myRole = players[myID].role;
        document.getElementById('role-name').innerText = `ÎÇ¥ ÏßÅÏóÖ: ${myRole}`;
        document.getElementById('role-name').style.color = (players[myID].team === "mafia") ? "var(--mafia)" : "var(--citizen)";
        document.getElementById('role-desc').innerText = ROLES[myRole]?.desc || "ÎåÄÍ∏∞ Ï§ë...";
    }

    const phaseEl = document.getElementById('phase-display');
    phaseEl.innerText = `üïí ${gameState.phase} - ${gameState.day || 0}Ïùº`;
    document.body.style.backgroundColor = (gameState.phase === "NIGHT") ? "#050505" : "#0d0d0f";
});

// --- [8] Î∞§ Í≤∞Í≥º Ï≤òÎ¶¨ Î∞è ÏäπÎ¶¨ ÌåêÏ†ï (Î∞©Ïû• Ï†ÑÏö©) ---
setInterval(() => {
    // Í∞ÄÏû• Î®ºÏ†Ä ÏûÖÏû•Ìïú ÏÇ¨ÎûåÏù¥ Î∞©Ïû• Ïó≠Ìï†ÏùÑ ÏàòÌñâÌïòÏó¨ Í≤∞Í≥º Ï≤òÎ¶¨
    if (gameState.phase === "NIGHT" && Object.keys(gameState.players)[0] === myID) {
        const targets = gameState.targetList || {};
        const activePlayers = Object.values(gameState.players).filter(p => p.isAlive && p.role !== "ÏãúÎØº" && p.role !== "Ï†ïÏπòÏù∏");
        
        if (Object.keys(targets).length >= activePlayers.length && activePlayers.length > 0) {
            processNightResults();
        }
    }
}, 4000);

function processNightResults() {
    const players = gameState.players;
    const targets = gameState.targetList || {};
    let deadTonight = new Set();
    let logs = [];

    // 1. Í∏∞Ïà†Ïûê Îä•Î†• Ï∞®Îã®
    Object.values(targets).forEach(t => {
        if (t.role === "Í∏∞Ïà†Ïûê" && targets[t.to]) {
            delete targets[t.to];
            logs.push("‚öôÔ∏è Í∏∞Ïà†ÏûêÍ∞Ä Îä•Î†•ÏùÑ Ï∞®Îã®ÌñàÏäµÎãàÎã§!");
        }
    });

    // 2. ÏùòÏÇ¨ ÏπòÎ£å ÌôïÏù∏
    const healed = new Set();
    Object.values(targets).forEach(t => { if (t.role === "ÏùòÏÇ¨") healed.add(t.to); });

    // 3. Í≥µÍ≤© ÌåêÏ†ï
    Object.values(targets).forEach(t => {
        if (["ÎßàÌîºÏïÑ", "ÎßàÎÖÄ", "ÏïîÏÇ¥Ïûê", "ÏûêÍ≤ΩÎã®"].includes(t.role)) {
            if (healed.has(t.to) && t.role !== "ÎßàÎÖÄ") {
                logs.push("üè• ÏùòÏÇ¨Í∞Ä ÎàÑÍµ∞Í∞ÄÎ•º ÏÇ¥Î†§ÎÉàÏäµÎãàÎã§!");
            } else if (players[t.to].role === "Íµ∞Ïù∏" && players[t.to].life > 0) {
                players[t.to].life--;
                logs.push("üõ°Ô∏è Íµ∞Ïù∏Ïù¥ Í≥µÍ≤©ÏùÑ Î≤ÑÌÖºÏäµÎãàÎã§!");
            } else {
                deadTonight.add(t.to);
            }
        }
    });

    deadTonight.forEach(uid => { players[uid].isAlive = false; logs.push(`üíÄ ${uid}ÎãòÏù¥ ÏÇ¨ÎßùÌñàÏäµÎãàÎã§.`); });
    if (logs.length === 0) logs.push("‚òÄÔ∏è ÏßÄÎÇúÎ∞§ÏóêÎäî ÏïÑÎ¨¥ ÏùºÎèÑ ÏóÜÏóàÏäµÎãàÎã§.");

    const winner = checkVictory(players);
    db.ref(`rooms/${roomID}`).update({
        players: players, phase: "DAY", targetList: {}, day: gameState.day + 1, winner: winner || null
    });
    
    logs.forEach(l => db.ref(`rooms/${roomID}/chats`).push({ sender: "ÏãúÏä§ÌÖú", text: l }));
}

function checkVictory(players) {
    const alive = Object.values(players).filter(p => p.isAlive);
    const mCount = alive.filter(p => p.team === "mafia").length;
    const cCount = alive.filter(p => p.team === "citizen").length;
    if (mCount === 0) return "CITIZEN";
    if (mCount >= cCount) return "MAFIA";
    return null;
}

db.ref(`rooms/${roomID}/winner`).on('value', (snap) => {
    if (snap.val()) alert(`${snap.val()} ÏäπÎ¶¨!`);
});
</script>
</body>
</html>
